# URL Cutter - Сервис сокращения ссылок

API-сервис для сокращения ссылок, аналогичный TinyURL или Bitly.

## Функциональность

### Основные функции:
- Создание, удаление, изменение и получение информации о коротких ссылках
- Статистика использования ссылок (клики, даты создания/использования)
- Кастомные короткие ссылки (пользовательский алиас)
- Поиск ссылок по оригинальному URL
- Настройка времени жизни ссылок

### Дополнительная функциональность:
- **Создание коротких ссылок без необходимости авторизации**
- Регистрация и авторизация для дополнительных возможностей управления ссылками
- Удаление истекших ссылок

## Технологии

- **Backend**: FastAPI, Python 3.13
- **База данных**: PostgreSQL для хранения ссылок и пользователей
- **Кэширование**: Valkey (совместимый с Redis форк)
- **Контейнеризация**: Docker & Docker Compose

## Срок действия ссылок

У всех ссылок есть срок действия. После истечения этого срока ссылки автоматически становятся недоступными.

### Настройка срока действия ссылок

Есть два способа настроить срок действия ссылок:

1. **Индивидуальная настройка:** При создании ссылки можно указать параметр `expires_at` с конкретной датой и временем истечения срока действия:

```json
{
  "original_url": "https://www.example.com/very/long/url",
  "custom_alias": "mylink",
  "expires_at": "2026-12-31T23:59:00Z"
}
```

2. **Глобальная настройка:** Если время `expires_at` не указано при создании ссылки, используется значение по умолчанию - 180 дней с момента создания. Это значение можно изменить в файле `app/core/config.py`:

```python
# Link settings
LINK_EXPIRATION_DAYS: int = 180  # Срок действия ссылок в днях
```

## API Endpoints

### Публичные эндпоинты (без авторизации)

- `POST /links/shorten` - Создание короткой ссылки (с опциональным параметром expires_at)
- `GET /{short_code}` - Перенаправление по короткому коду

### Эндпоинты авторизации

- `POST /auth/register` - Регистрация нового пользователя (возвращает токен доступа)
- `POST /auth/login` - Получение токена доступа для существующего пользователя

### Эндпоинты управления ссылками (требуют авторизацию)

- `GET /links/{short_code}` - Получение информации о ссылке
- `GET /links/{short_code}/stats` - Получение статистики по ссылке
- `PUT /links/{short_code}` - Обновление ссылки
- `DELETE /links/{short_code}` - Удаление ссылки
- `GET /links/search?original_url={url}` - Поиск ссылки по оригинальному URL


## Запуск проекта

### Предварительные требования
- Docker

### Шаги для запуска

1. Клонирование репозитория:
```bash
git clone https://github.com/yourusername/url_cutter.git
cd url_cutter
```

2. Запуск приложения с помощью Docker Compose:
```bash
docker compose up -d
```

3. Инициализация базы данных:
```bash
docker compose exec app python -m app.db.init_db
```

4. Сервис доступен по адресу: http://localhost:8000

## Структура базы данных

### Пользователи (User)
- id: Первичный ключ
- email: Уникальный email пользователя
- username: Уникальное имя пользователя
- hashed_password: Хэшированный пароль
- is_active: Флаг активности
- is_superuser: Флаг суперпользователя

### Ссылки (Link)
- id: Первичный ключ
- original_url: Оригинальный URL
- short_code: Уникальный короткий код
- user_id: Внешний ключ на пользователя (опционально)
- clicks: Счетчик кликов
- last_used_at: Время последнего использования
- expires_at: Время истечения ссылки (может быть указано пользователем или установлено по умолчанию)
- is_active: Флаг активности
- is_anonymous: Флаг анонимной ссылки


## Структура проекта

```
url_cutter/
├── app/                      # Основной пакет приложения
│   ├── api/                  # API маршруты
│   │   ├── routes/           # Определения маршрутов
│   │   │   ├── auth.py       # Маршруты аутентификации
│   │   │   └── links.py      # Маршруты для работы со ссылками
│   │   └── __init__.py
│   ├── core/                 # Основные настройки и конфигурация
│   │   ├── config.py         # Настройки приложения
│   │   ├── deps.py           # Зависимости (Dependencies)
│   │   └── security.py       # Функции безопасности
│   ├── crud/                 # CRUD операции
│   │   ├── link.py           # Операции с ссылками
│   │   └── user.py           # Операции с пользователями
│   ├── db/                   # Настройки базы данных
│   │   ├── base.py           # Базовые классы для моделей
│   │   ├── redis.py          # Настройки Redis
│   │   └── session.py        # Настройки сессии базы данных
│   ├── models/               # Модели SQLAlchemy
│   │   ├── link.py           # Модель ссылки
│   │   └── user.py           # Модель пользователя
│   ├── schemas/              # Pydantic схемы
│   │   ├── link.py           # Схемы для ссылок
│   │   ├── token.py          # Схемы для токенов
│   │   └── user.py           # Схемы для пользователей
│   ├── __init__.py
│   └── main.py               # Точка входа приложения
├── .env                      # Переменные окружения
├── docker-compose.yml        # Конфигурация Docker Compose
├── Dockerfile                # Инструкции для сборки Docker-образа
├── README.md                 # Документация проекта
├── render.yaml               # Конфигурация для деплоя на Render
└── requirements.txt          # Зависимости проекта
```

## Описание компонентов

### API (app/api/routes/)
- **auth.py**: Маршруты для регистрации и аутентификации пользователей
- **links.py**: Маршруты для создания, получения, обновления и удаления ссылок

### Core (app/core/)
- **config.py**: Настройки приложения, включая подключение к базе данных и Redis
- **deps.py**: Зависимости FastAPI для аутентификации и авторизации
- **security.py**: Функции для хеширования паролей и генерации токенов

### CRUD (app/crud/)
- **link.py**: Операции с базой данных для ссылок (создание, чтение, обновление, удаление)
- **user.py**: Операции с базой данных для пользователей

### DB (app/db/)
- **base.py**: Базовые классы для моделей SQLAlchemy
- **redis.py**: Настройки подключения к Redis
- **session.py**: Настройки сессии базы данных

### Models (app/models/)
- **link.py**: Модель SQLAlchemy для ссылок
- **user.py**: Модель SQLAlchemy для пользователей

### Schemas (app/schemas/)
- **link.py**: Pydantic схемы для валидации данных ссылок
- **token.py**: Pydantic схемы для токенов аутентификации
- **user.py**: Pydantic схемы для валидации данных пользователей

### Main (app/main.py)
- Точка входа приложения
- Настройка FastAPI
- Подключение маршрутов
- Инициализация базы данных при запуске
